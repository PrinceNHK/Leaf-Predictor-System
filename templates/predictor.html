<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disease Predictor - LeafGuard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <span>LeafGuard</span>
            </div>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/#diseases" class="nav-link">Diseases</a></li>
                <li><a href="/predictor" class="nav-link btn-predict">Predict Now</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="predictor-section">
        <div class="container">
            <div class="predictor-card">
                <h1>üîç Disease Detection</h1>
                <p>Upload a tomato leaf image to detect diseases and get treatment recommendations</p>

                <div class="predictor-container">
                    <!-- Upload Area -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3>Upload Leaf Image</h3>
                        <p>Drag and drop your image here or click to browse</p>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-image"></i> Choose File
                        </button>
                        <p class="file-info">Supported formats: JPG, PNG, GIF, BMP (Max 16MB)</p>
                    </div>

                    <!-- Preview Area -->
                    <div class="preview-area" id="previewArea" style="display: none;">
                        <div class="image-preview">
                            <img id="previewImage" src="" alt="Preview">
                            <button class="btn-remove" onclick="resetUpload()" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <button class="btn btn-primary btn-predict-submit" onclick="predictDisease()">
                            <i class="fas fa-magic"></i> Analyze Image
                        </button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Analyzing your leaf image...</p>
                </div>

                <!-- Results Area -->
                <div class="results-area" id="resultsArea" style="display: none;">
                    <div class="result-container">
                        <div class="result-header">
                            <h2 id="diseaseName"></h2>
                            <div class="confidence-badge">
                                <span id="confidenceText"></span>
                            </div>
                        </div>

                        <!-- Disease Details -->
                        <div class="disease-details">
                            <p id="diseaseDescription"></p>
                        </div>

                        <!-- Tabs for Information -->
                        <div class="tabs">
                            <div class="tab-buttons">
                                <button class="tab-btn active" data-tab="symptoms">Symptoms</button>
                                <button class="tab-btn" data-tab="causes">Causes</button>
                                <button class="tab-btn" data-tab="prevention">Prevention</button>
                                <button class="tab-btn" data-tab="treatment">Treatment</button>
                            </div>

                            <div class="tab-content">
                                <div class="tab-pane active" id="symptoms-tab">
                                    <ul id="symptomsList" class="info-list"></ul>
                                </div>
                                <div class="tab-pane" id="causes-tab">
                                    <p id="causeText"></p>
                                </div>
                                <div class="tab-pane" id="prevention-tab">
                                    <ul id="preventionList" class="info-list"></ul>
                                </div>
                                <div class="tab-pane" id="treatment-tab">
                                    <ul id="treatmentList" class="info-list"></ul>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="backToUpload()">
                                <i class="fas fa-arrow-left"></i> Upload New Image
                            </button>
                            <a href="/" class="btn btn-secondary">
                                <i class="fas fa-home"></i> Back to Home
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div class="error-message" id="errorMessage" style="display: none;"></div>
            </div>
        </div>
    </section>

    <!-- Tips Section -->
    <section class="tips-section">
        <div class="container">
            <h2>üì∏ Tips for Best Results</h2>
            <div class="tips-grid">
                <div class="tip-card">
                    <i class="fas fa-sun"></i>
                    <h4>Good Lighting</h4>
                    <p>Take photos in natural sunlight for clear images</p>
                </div>
                <div class="tip-card">
                    <i class="fas fa-expand"></i>
                    <h4>Close-up Shot</h4>
                    <p>Capture the affected leaf area clearly</p>
                </div>
                <div class="tip-card">
                    <i class="fas fa-focus"></i>
                    <h4>Sharp Focus</h4>
                    <p>Ensure the image is in focus, not blurry</p>
                </div>
                <div class="tip-card">
                    <i class="fas fa-ban"></i>
                    <h4>Avoid Shadows</h4>
                    <p>Minimize shadows and reflections on the leaf</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 LeafGuard. Powered by AI-driven Disease Detection</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const previewArea = document.getElementById('previewArea');
        const previewImage = document.getElementById('previewImage');
        const loading = document.getElementById('loading');
        const resultsArea = document.getElementById('resultsArea');
        const errorMessage = document.getElementById('errorMessage');

        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFileUpload(file);
            }
        });

        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                fileInput.value = '';
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                uploadArea.style.display = 'none';
                previewArea.style.display = 'block';
                errorMessage.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            fileInput.value = '';
            previewArea.style.display = 'none';
            uploadArea.style.display = 'block';
            resultsArea.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        function backToUpload() {
            previewArea.style.display = 'block';
            resultsArea.style.display = 'none';
            loading.style.display = 'none';
        }

        async function predictDisease() {
            const file = fileInput.files[0];
            if (!file) {
                showError('Please select an image first');
                return;
            }

            loading.style.display = 'flex';
            previewArea.style.display = 'none';
            errorMessage.style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Prediction failed');
                }

                displayResults(data);
            } catch (error) {
                loading.style.display = 'none';
                previewArea.style.display = 'block';
                showError(error.message);
            }
        }

        function displayResults(data) {
            loading.style.display = 'none';
            resultsArea.style.display = 'block';

            const confidencePercentage = data.confidence;
            const confidenceBadge = document.querySelector('.confidence-badge');
            
            if (confidencePercentage >= 80) {
                confidenceBadge.className = 'confidence-badge high';
            } else if (confidencePercentage >= 60) {
                confidenceBadge.className = 'confidence-badge medium';
            } else {
                confidenceBadge.className = 'confidence-badge low';
            }

            document.getElementById('diseaseName').textContent = data.disease;
            document.getElementById('confidenceText').textContent = `${confidencePercentage.toFixed(1)}% Confidence`;
            document.getElementById('diseaseDescription').textContent = data.description;
            document.getElementById('symptomsList').innerHTML = data.symptoms.map(s => `<li><i class="fas fa-check"></i> ${s}</li>`).join('');
            document.getElementById('causeText').textContent = data.causes;
            document.getElementById('preventionList').innerHTML = data.prevention.map(p => `<li><i class="fas fa-shield-alt"></i> ${p}</li>`).join('');
            document.getElementById('treatmentList').innerHTML = data.treatment.map(t => `<li><i class="fas fa-pills"></i> ${t}</li>`).join('');

            // Reset tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelector('[data-tab="symptoms"]').classList.add('active');
            document.getElementById('symptoms-tab').classList.add('active');
        }

        function showError(message) {
            errorMessage.style.display = 'block';
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
    </script>
</body>
</html>
